generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== KULLANICILAR ====================

model User {
  id            String    @id @default(cuid())
  username      String    @unique
  displayName   String
  role          String    @default("user") // "admin" | "user"
  passwordHash  String
  createdAt     DateTime  @default(now())
  examTrack     String?  // "sayisal" | "ea" | "sozel" — null = henüz seçilmemiş

  folders        Folder[]
  tasks          Task[]
  taskCompletions TaskCompletion[]
  taskComments   TaskComment[]
  exams          Exam[]
  metricDefs     MetricDefinition[]
  metricEntries  MetricEntry[]
  checkIns       DailyCheckIn[]
  errorReasons   ErrorReason[]
  files          UserFile[]
  notificationsReceived Notification[] @relation("NotificationRecipient")
  notificationsSent     Notification[] @relation("NotificationSender")
  dailyStudies   DailyStudy[]
  topicReviews   TopicReview[]
  topicKnowledge TopicKnowledge[]
  weeklyPlans    WeeklyPlan[]
  weeklyAnalyses WeeklyAnalysis[]
  aiChatMessages AIChatMessage[]
  aiInsights     AIInsight[]
  aiEnabled      Boolean  @default(false)
  speedReadingSessions SpeedReadingSession[]
  speedReadingExercises SpeedReadingExercise[]
  spacedRepetitionItems SpacedRepetitionItem[]
  targetScores   TargetScore[]
  streaks        UserStreak[]
  badges         UserBadge[]
  questionBanks  QuestionBank[]
  studentProfile StudentProfile?
  kazanimProgress KazanimProgress[]
}

// ==================== KLASÖRLER & GÖREVLER ====================

model Folder {
  id        String   @id @default(cuid())
  name      String
  color     String
  parentId  String?
  parent    Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children  Folder[] @relation("FolderHierarchy")
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  tasks     Task[]
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([parentId])
}

model Task {
  id           String           @id @default(cuid())
  title        String
  description  String?
  completed    Boolean          @default(false)
  priority     String           @default("medium") // "low" | "medium" | "high"
  dueDate      DateTime?
  isRecurring  Boolean          @default(false)
  recurrence   String?          // "daily" | "weekly" | "monthly"
  folderId     String
  folder       Folder           @relation(fields: [folderId], references: [id])
  assignedById String
  assignedBy   User             @relation(fields: [assignedById], references: [id])
  completions  TaskCompletion[]
  comments     TaskComment[]
  sortOrder    Int              @default(0)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([folderId])
  @@index([assignedById])
}

model TaskCompletion {
  id          String   @id @default(cuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  completedAt DateTime @default(now())

  @@index([taskId])
}

model TaskComment {
  id              String   @id @default(cuid())
  content         String
  isEncouragement Boolean  @default(false)
  taskId          String
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId        String
  author          User     @relation(fields: [authorId], references: [id])
  createdAt       DateTime @default(now())

  @@index([taskId])
}

// ==================== DENEME ANALİZ SİSTEMİ ====================

model ExamType {
  id       String    @id @default(cuid())
  name     String    // "TYT", "AYT"
  slug     String    @unique
  subjects Subject[]
  exams    Exam[]

  @@index([slug])
}

model Subject {
  id            String   @id @default(cuid())
  name          String   // "Matematik", "Türkçe"
  questionCount Int      @default(40) // varsayılan soru sayısı
  examTypeId    String
  examType      ExamType @relation(fields: [examTypeId], references: [id])
  topics        Topic[]
  examResults   ExamSubjectResult[]
  wrongQuestions ExamWrongQuestion[]
  emptyQuestions ExamEmptyQuestion[]
  dailyStudies    DailyStudy[]
  topicReviews    TopicReview[]
  weeklyPlanItems WeeklyPlanItem[]
  spacedRepetitionItems SpacedRepetitionItem[]
  targetScores   TargetScore[]
  sortOrder       Int      @default(0)

  @@index([examTypeId])
}

model Topic {
  id            String   @id @default(cuid())
  name          String   // "Türev", "Paragraf"
  subjectId     String
  subject       Subject  @relation(fields: [subjectId], references: [id])
  difficulty    Int      @default(3)  // 1-5 zorluk seviyesi
  estimatedHours Float   @default(2)  // Tahmini toplam çalışma saati
  wrongQuestions ExamWrongQuestion[]
  emptyQuestions ExamEmptyQuestion[]
  dailyStudies    DailyStudy[]
  topicReviews    TopicReview[]
  topicKnowledge  TopicKnowledge[]
  weeklyPlanItems WeeklyPlanItem[]
  spacedRepetitionItems SpacedRepetitionItem[]
  prerequisites    TopicPrerequisite[] @relation("TopicPrereqs")
  prerequisiteOf   TopicPrerequisite[] @relation("PrereqOf")
  concepts         TopicConcept[]
  kazanimlar       TopicKazanim[]
  sortOrder       Int      @default(0)

  @@index([subjectId])
}

model ErrorReason {
  id             String   @id @default(cuid())
  label          String   // "Bilgi eksikliği", "Dikkatsizlik"
  isDefault      Boolean  @default(false)
  userId         String?  // null = sistem varsayılanı
  user           User?    @relation(fields: [userId], references: [id])
  wrongQuestions ExamWrongQuestion[]
  createdAt      DateTime @default(now())
}

model Exam {
  id            String              @id @default(cuid())
  title         String              // "Özdebir TYT Deneme 3"
  examTypeId    String
  examType      ExamType            @relation(fields: [examTypeId], references: [id])
  examCategory  String?             // null = genel deneme, "brans" = branş denemesi
  date          DateTime
  userId        String
  user          User                @relation(fields: [userId], references: [id])
  notes         String?
  subjectResults ExamSubjectResult[]
  wrongQuestions ExamWrongQuestion[]
  emptyQuestions ExamEmptyQuestion[]
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([userId])
  @@index([examTypeId])
  @@index([date])
}

model ExamSubjectResult {
  id           String  @id @default(cuid())
  examId       String
  exam         Exam    @relation(fields: [examId], references: [id], onDelete: Cascade)
  subjectId    String
  subject      Subject @relation(fields: [subjectId], references: [id])
  correctCount Int
  wrongCount   Int
  emptyCount   Int
  netScore     Float   // Doğru - (Yanlış / 4)

  @@unique([examId, subjectId])
  @@index([examId])
}

model ExamWrongQuestion {
  id            String       @id @default(cuid())
  examId        String
  exam          Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  subjectId     String
  subject       Subject      @relation(fields: [subjectId], references: [id])
  topicId       String?
  topic         Topic?       @relation(fields: [topicId], references: [id])
  questionNumber Int
  errorReasonId String?
  errorReason   ErrorReason? @relation(fields: [errorReasonId], references: [id])
  notes         String?
  photoUrl      String?
  photoR2Key    String?
  difficulty    String?      // "kolay" | "orta" | "zor"
  understandingStatus String? // "anladim" | "tekrar" | "anlamadim"
  spacedRepetitionItems SpacedRepetitionItem[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime?    @updatedAt

  @@index([examId])
  @@index([subjectId])
  @@index([topicId])
  @@index([errorReasonId])
}

model ExamEmptyQuestion {
  id             String   @id @default(cuid())
  examId         String
  exam           Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  subjectId      String
  subject        Subject  @relation(fields: [subjectId], references: [id])
  topicId        String?
  topic          Topic?   @relation(fields: [topicId], references: [id])
  questionNumber Int
  notes          String?
  createdAt      DateTime @default(now())

  @@index([examId])
  @@index([subjectId])
}

// ==================== METRİKLER & CHECK-IN ====================

model MetricDefinition {
  id        String        @id @default(cuid())
  name      String        // "Kilo", "Su Tüketimi"
  unit      String?       // "kg", "bardak"
  icon      String?       // lucide icon adı
  color     String?       // hex renk
  type      String        @default("number") // "number" | "rating" | "boolean" | "duration"
  isActive  Boolean       @default(true)
  userId    String
  user      User          @relation(fields: [userId], references: [id])
  entries   MetricEntry[]
  sortOrder Int           @default(0)
  createdAt DateTime      @default(now())

  @@index([userId])
}

model MetricEntry {
  id         String           @id @default(cuid())
  value      Float
  date       DateTime
  note       String?
  metricId   String
  metric     MetricDefinition @relation(fields: [metricId], references: [id], onDelete: Cascade)
  userId     String
  user       User             @relation(fields: [userId], references: [id])
  createdAt  DateTime         @default(now())

  @@unique([metricId, userId, date])
  @@index([date])
}

model DailyCheckIn {
  id        String   @id @default(cuid())
  date      DateTime
  mood      Int?     // 1-5
  energy    Int?     // 1-5
  sleep     Float?   // saat
  gratitude String?
  notes     String?
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ==================== BİLDİRİMLER ====================

model Notification {
  id          String   @id @default(cuid())
  type        String   // "encouragement" | "reminder" | "milestone" | "streak" | "task_assigned"
  title       String
  message     String
  isRead      Boolean  @default(false)
  recipientId String
  recipient   User     @relation("NotificationRecipient", fields: [recipientId], references: [id])
  senderId    String?
  sender      User?    @relation("NotificationSender", fields: [senderId], references: [id])
  createdAt   DateTime @default(now())

  @@index([recipientId])
  @@index([isRead])
}

// ==================== GÜNLÜK ÇALIŞMA ====================

model DailyStudy {
  id            String          @id @default(cuid())
  date          DateTime
  userId        String
  user          User            @relation(fields: [userId], references: [id])
  subjectId     String
  subject       Subject         @relation(fields: [subjectId], references: [id])
  topicId       String?
  topic         Topic?          @relation(fields: [topicId], references: [id])
  questionCount Int             // Çözülen soru sayısı
  correctCount  Int             @default(0)
  wrongCount    Int             @default(0)
  emptyCount    Int             @default(0)
  difficulty    String?         // "kolay" | "orta" | "zor"
  source        String?         // Kaynak kitap/test adı
  duration      Int?            // Dakika cinsinden süre
  photoUrl      String?
  photoR2Key    String?
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([userId])
  @@index([date])
  @@index([subjectId])
}

model TopicReview {
  id            String   @id @default(cuid())
  date          DateTime
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  subjectId     String
  subject       Subject  @relation(fields: [subjectId], references: [id])
  topicId       String
  topic         Topic    @relation(fields: [topicId], references: [id])
  duration      Int?     // Dakika cinsinden süre
  confidence    String?  // "dusuk" | "orta" | "yuksek"
  method        String?  // "video" | "kitap" | "ders_notu" | "soru_cozumu" | "diger"
  photoUrl      String?
  photoR2Key    String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([date])
  @@index([subjectId])
  @@index([topicId])
}

// ==================== DOSYALAR ====================

model UserFile {
  id        String   @id @default(cuid())
  name      String
  url       String
  r2Key     String
  mimeType  String
  sizeBytes Int
  folderId  String?
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([userId])
}

// ==================== STRATEJİ & AI ====================

model TopicKnowledge {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  topicId   String
  topic     Topic    @relation(fields: [topicId], references: [id])
  level     Int      @default(0) // 0-5: 0=Hiç bilmiyorum, 1=Çok az, 2=Temel, 3=Orta, 4=İyi, 5=Çok iyi
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([userId, topicId])
  @@index([userId])
  @@index([topicId])
}

model WeeklyPlan {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  title     String
  startDate DateTime
  endDate   DateTime
  notes     String?
  items     WeeklyPlanItem[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([userId])
  @@index([startDate])
}

model WeeklyPlanItem {
  id            String     @id @default(cuid())
  weeklyPlanId  String
  weeklyPlan    WeeklyPlan @relation(fields: [weeklyPlanId], references: [id], onDelete: Cascade)
  dayOfWeek     Int        // 0=Pazartesi, 1=Salı, ... 6=Pazar
  subjectId     String
  subject       Subject    @relation(fields: [subjectId], references: [id])
  topicId       String?
  topic         Topic?     @relation(fields: [topicId], references: [id])
  duration      Int?       // Planlanan dakika
  questionCount Int?       // Planlanan soru sayısı
  completed     Boolean    @default(false)
  notes         String?
  sortOrder     Int        @default(0)

  @@index([weeklyPlanId])
  @@index([dayOfWeek])
}

model WeeklyAnalysis {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  weekStartDate     DateTime
  weekEndDate       DateTime
  plannedItems      Int      @default(0)
  completedItems    Int      @default(0)
  totalStudyMinutes Int      @default(0)
  totalQuestions    Int      @default(0)
  netScoreChanges   Json?    // [{ subjectName, previousNet, currentNet }]
  aiSummary         String?  // AI markdown yorumu
  aiRecommendations String?  // AI önerileri
  createdAt         DateTime @default(now())

  @@unique([userId, weekStartDate])
  @@index([userId])
}

model AIChatMessage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      String   // "user" | "assistant" | "system"
  content   String
  metadata  Json?    // { voiceInput: boolean, tokens: number }
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// ==================== HIZLI OKUMA ====================

model SpeedReadingSession {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  title         String?
  wordCount     Int
  wordsRead     Int
  initialWpm    Int
  finalWpm      Int
  chunkSize     Int      @default(1)
  autoSpeed     Boolean  @default(false)
  duration      Int      // saniye
  completed     Boolean  @default(false)
  comprehension Int?     // 1-5 anlama öz değerlendirmesi
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model SpeedReadingExercise {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  exerciseType  String   // "schulte" | "tachistoscope" | "peripheral"
  difficulty    Int      @default(1) // 1-5
  score         Float    // 0-100 yüzde
  duration      Int      // saniye
  completed     Boolean  @default(true)
  metadata      Json?    // Tip-spesifik veriler
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([exerciseType])
  @@index([createdAt])
}

// ==================== SPACED REPETITION ====================

model SpacedRepetitionItem {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  wrongQuestionId String
  wrongQuestion   ExamWrongQuestion @relation(fields: [wrongQuestionId], references: [id], onDelete: Cascade)
  subjectId       String
  subject         Subject  @relation(fields: [subjectId], references: [id])
  topicId         String?
  topic           Topic?   @relation(fields: [topicId], references: [id])
  nextReviewDate  DateTime
  interval        Int      @default(1) // gun cinsinden
  repetitionCount Int      @default(0)
  easeFactor      Float    @default(2.5)
  status          String   @default("pending") // "pending" | "mastered"
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, nextReviewDate])
  @@index([userId, subjectId, topicId])
  @@index([userId, status])
}

// ==================== HEDEF NET ====================

model TargetScore {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  targetNet Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, subjectId])
}

// ==================== STREAK & ROZET ====================

model UserStreak {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id])
  type           String    // "daily_study" | "plan_completion"
  currentStreak  Int       @default(0)
  longestStreak  Int       @default(0)
  lastActiveDate DateTime?
  updatedAt      DateTime  @updatedAt

  @@unique([userId, type])
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  badgeType String
  earnedAt  DateTime @default(now())

  @@unique([userId, badgeType])
}

// ==================== SORU BANKASI ====================

model QuestionBank {
  id         String             @id @default(cuid())
  type       String             // "paragraph" | "vocabulary" | ...
  difficulty Int                @default(3) // 1-5
  title      String?
  content    String             // Paragraf metni
  questions  QuestionBankItem[]
  createdBy  String
  creator    User               @relation(fields: [createdBy], references: [id])
  createdAt  DateTime           @default(now())

  @@index([type, difficulty])
  @@index([createdBy])
}

model QuestionBankItem {
  id             String       @id @default(cuid())
  questionBankId String
  questionBank   QuestionBank @relation(fields: [questionBankId], references: [id], onDelete: Cascade)
  question       String
  options        Json         // ["A seçeneği", "B seçeneği", "C seçeneği", "D seçeneği"]
  correctAnswer  Int          // 0-3 (index)
  explanation    String?
  sortOrder      Int          @default(0)
}

// ==================== AI INSIGHT'LAR ====================

model AIInsight {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String   // "weekly_analysis" | "exam_analysis" | "plan_generation" | "dashboard"
  title     String   // Kısa başlık: "Hafta 8 Analizi", "TYT Deneme 3 Yorumu"
  content   String   // Markdown AI çıktısı
  context   Json?    // AI'a gönderilen context verisi (tekrar işlenebilir)
  metadata  Json?    // { examId?, weekStart?, planId?, tokens? }
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// ==================== ÖĞRENCİ PROFİLİ ====================

model StudentProfile {
  id               String   @id @default(cuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyStudyHours  Float?   // Günlük ortalama çalışma saati
  availableDays    Json?    // [0,1,2,3,4,5,6] — hangi günler müsait
  studyRegularity  String?  // "duzenli" | "duzensiz"
  breakPreference  String?  // "25_5" | "45_15" | "60_15" (pomodoro vs.)
  examDate         DateTime? // YKS sınav tarihi
  targetRank       Int?     // Hedef sıralama
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ==================== KONU ÖN-KOŞULLARI ====================

model TopicPrerequisite {
  id              String @id @default(cuid())
  topicId         String
  topic           Topic  @relation("TopicPrereqs", fields: [topicId], references: [id], onDelete: Cascade)
  prerequisiteId  String
  prerequisite    Topic  @relation("PrereqOf", fields: [prerequisiteId], references: [id], onDelete: Cascade)
  strength        String @default("hard") // "hard" = kesin gerekli, "soft" = tavsiye edilen

  @@unique([topicId, prerequisiteId])
  @@index([topicId])
  @@index([prerequisiteId])
}

// ==================== KAZANIM SİSTEMİ ====================

model TopicKazanim {
  id            String   @id @default(cuid())
  topicId       String
  topic         Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  code          String   // "9.1.1.1", "10.2.3.1"
  subTopicName  String?  // Konu başlığı: "Önermeler ve Bileşik Önermeler"
  description   String   // Kazanım metni
  details       String?  // Alt açıklamalar (a, b, c) — multiline text
  isKeyKazanim  Boolean  @default(false) // Anahtar kazanım işareti
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  progress      KazanimProgress[]

  @@index([topicId])
}

model KazanimProgress {
  id         String       @id @default(cuid())
  userId     String
  user       User         @relation(fields: [userId], references: [id])
  kazanimId  String
  kazanim    TopicKazanim @relation(fields: [kazanimId], references: [id], onDelete: Cascade)
  checked    Boolean      @default(false)
  notes      String?
  updatedAt  DateTime     @updatedAt
  createdAt  DateTime     @default(now())

  @@unique([userId, kazanimId])
  @@index([userId])
  @@index([kazanimId])
}

// ==================== ANAHTAR KAVRAMLAR ====================

model TopicConcept {
  id          String   @id @default(cuid())
  topicId     String
  topic       Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  name        String   // "Türev tanımı", "L'Hôpital kuralı"
  description String?  // Kısa açıklama
  formula     String?  // "lim(x→a) f(x) = L" veya LaTeX
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([topicId])
}
